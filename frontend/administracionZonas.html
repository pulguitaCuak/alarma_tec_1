<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Dashboard - Alarma</title>
  <!-- Bootstrap local -->
  <link rel="stylesheet" href="/alarma_tec_1/frontend/css/bootstrap.custom.min.css">
  <link rel="stylesheet" href="/alarma_tec_1/frontend/bootstrap-icons-1.13.1/bootstrap-icons.css">
  <!-- Estilos personalizados -->
  <link rel="stylesheet" href="/alarma_tec_1/frontend/css/plantillaPrincipal.css">
  <link rel="stylesheet" href="/alarma_tec_1/frontend/css/administracionZonas.css">



</head>
<body class="bg-light d-flex flex-column min-vh-100  overflow: hidden;">

  <!-- HEADER -->
  <header class="bg-primary text-white py-3 d-flex align-items-center justify-content-between px-4">
    <div class="d-flex align-items-center">
      <!-- Botón hamburguesa móvil -->
      <button class="btn btn-outline-light d-lg-none me-3" id="toggleSidebar">
        <i class="bi bi-list"></i>
      </button>
      <h1 class="h4 m-0"><a href="/alarma_tec_1/frontend/index.html" class="navbar-brand">Alarma</a></h1>
    </div>
    <div class="d-flex align-items-center">
      <h2 class="h5 m-0 me-2">Dashboard</h2>
      <i class="bi bi-grid fs-5"></i>
    </div>
  </header>

  <!-- MAIN -->
  <main class="flex-fill">

  <div class="d-flex flex-grow-1 min-vh-100">
    <!-- SIDEBAR (oculta en móvil) -->
    <aside id="sidebar" class="sidebar bg-dark d-flex flex-column align-items-center py-4 min-vh-100">
      <a href="/alarma_tec_1/frontend/administracionUsuarios.html" class="my-3"><i class="bi bi-house fs-4 p-4"></i></a>
      <a href="/alarma_tec_1/frontend/dashboardEquipos.html" class="my-3"><i class="bi bi-grid fs-4 p-4"></i></a>
      <a href="/alarma_tec_1/frontend/administracionRegistrar.html" class="my-3"><i class="bi bi-person-plus fs-4 p-4"></i></a>
      <a href="/alarma_tec_1/frontend/administracionEquipos.html" class="my-3"><i class="bi bi-list fs-4 p-4"></i></a>
    </aside>  

    <!-- CONTENIDO CON CARDS -->
    <div class="flex-grow-1">
      <div class="d-flex row justify-content-center">
        <div class="row g-3 justify-content-between">

        <!--ENCONTRADOR-->
            <form class="d-flex encontrador px-4 gap-4 align-middle">
                <input class="form-control me-sm-2" type="search" id="searchZona" placeholder="Buscar zona...">
                <button class="btn btn-secondary my-2 my-sm-0" type="button" id="btnBuscar">Buscar</button>
            </form>

      <!-- TABLA DE ZONAS -->
      <div class="table-container mt-4">
        <div class="table-responsive">
          <table class="table" id="zonasTable">
            <tbody id="zonasTableBody">
              <tr>
                <td colspan="3" class="text-center">
                  <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Cargando...</span>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

          </div>
        </div>
      </div>
    </div>

  </main>

  <!-- FOOTER -->
  <footer class="bg-primary text-white text-center py-2 mt-auto">
  <small class="footer-text">2025 Escuela Técnica N°1 Gral. San Martín Inc. Todos los derechos reservados.</small>
</footer>

  <!-- OVERLAY Y MODALES -->
  <div id="overlay" class="overlay"></div>

  <!-- Modal Editar Zona -->
  <div class="popup-editar popup">
    <div class="popup-content">
      <h3>Modificar Zona</h3>
      <form>
        <div class="form-group mb-3">
          <label for="nuevoNombre" class="form-label">Nombre</label>
          <input type="text" class="form-control" id="nuevoNombre" placeholder="Nombre de la zona">
        </div>
        <div class="d-flex gap-2">
          <button type="button" class="btn btn-primary" id="btnAcetarCambios">Aceptar</button>
          <button type="button" class="btn btn-secondary" id="btnCancelarCambios">Cancelar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Eliminar Zona -->
  <div class="popup-eliminar popup">
    <div class="popup-content">
      <h3>¿Deseas eliminar esta zona?</h3>
      <p class="text-muted">Esta acción no se puede deshacer</p>
      <div class="d-flex gap-2">
        <button type="button" class="btn btn-danger" id="btnConfirmarEliminar">Eliminar</button>
        <button type="button" class="btn btn-secondary" id="btnCancelarEliminar">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- Bootstrap scripts -->
  <script src="/alarma_tec_1/frontend/js/bootstrap.bundle.js"></script>
  <script> 
    const sidebar = document.getElementById('sidebar');
    const toggleBtn = document.getElementById('toggleSidebar');
    const zonasTableBody = document.getElementById('zonasTableBody');
    const searchInput = document.getElementById('searchZona');
    const btnBuscar = document.getElementById('btnBuscar');

    toggleBtn.addEventListener('click', () => {
      sidebar.classList.toggle('show');
    });

    let todasZonas = [];

    // Cargar zonas al iniciar
    cargarZonas();

    async function cargarZonas() {
      try {
        const res = await fetch('/alarma_tec_1/back-end/obtener_todas_zonas.php');
        const data = await res.json();

        // Verificar si la respuesta es un array
        if (!Array.isArray(data)) {
          zonasTableBody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">No hay zonas disponibles</td></tr>';
          return;
        }

        if (data.length === 0) {
          zonasTableBody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">No hay zonas disponibles</td></tr>';
          return;
        }

        todasZonas = data;
        mostrarZonas(data);

      } catch (err) {
        console.error('Error:', err);
        zonasTableBody.innerHTML = '<tr><td colspan="3" class="text-center text-danger">Error al cargar zonas</td></tr>';
      }
    }

    function mostrarZonas(zonas) {
      zonasTableBody.innerHTML = '';

      if (zonas.length === 0) {
        zonasTableBody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">No hay resultados</td></tr>';
        return;
      }

      zonas.forEach(zona => {
        const row = document.createElement('tr');
        row.setAttribute('valign', 'middle');
        row.dataset.id = zona.id_zona;
        row.dataset.nombre = zona.nombre;

        row.innerHTML = `
          <th scope="row" class="fs-4">
            <i class="bi bi-house fs-2 p-2 hide-mobile"></i>
            ${zona.nombre}
          </th>
          <td class="fs-4 text-center align-middle"><small class="fs-6">Zona</small></td>
          <td class="fs-4">
            <div class="d-flex flex-wrap gap-2 w-100">
              <i class="bi bi-battery-full fs-4 px-4"></i>
              <button class="btn btn-danger text-body redondear-bordes flex-grow-1 flex-md-grow-0 btn-eliminar" onclick="abrirPopupEliminar(${zona.id_zona})">Eliminar</button>
              <button class="btn btn-light redondear-bordes border flex-grow-1 flex-md-grow-0 btn-modificar" onclick="abrirPopupEditar(${zona.id_zona}, '${zona.nombre}')">Modificar</button>
              <a href="/alarma_tec_1/frontend/silva/estructuraAdministracionSensores.html?id_zona=${zona.id_zona}" class="btn bg-secondary redondear-bordes flex-grow-1 flex-md-grow-0">Entrar</a>
            </div>
          </td>
        `;

        zonasTableBody.appendChild(row);
      });
    }

    // Buscar zonas
    function filtrarZonas() {
      const searchTerm = searchInput.value.toLowerCase();
      const zonasFiltradas = todasZonas.filter(zona => 
        zona.nombre.toLowerCase().includes(searchTerm)
      );
      mostrarZonas(zonasFiltradas);
    }

    searchInput.addEventListener('input', filtrarZonas);
    btnBuscar.addEventListener('click', (e) => {
      e.preventDefault();
      filtrarZonas();
    });

    // Variables globales para el popup
    let zonaSeleccionada = null;

    function abrirPopupEditar(id, nombre) {
      zonaSeleccionada = { id, nombre };
      document.getElementById('nuevoNombre').value = nombre;
      document.getElementById('overlay').classList.add('mostrar');
      document.querySelector('.popup-editar').classList.add('mostrar');
    }

    function abrirPopupEliminar(id) {
      zonaSeleccionada = { id };
      document.getElementById('overlay').classList.add('mostrar');
      document.querySelector('.popup-eliminar').classList.add('mostrar');
    }

    function cerrarPopups() {
      document.getElementById('overlay').classList.remove('mostrar');
      document.querySelector('.popup-editar').classList.remove('mostrar');
      document.querySelector('.popup-eliminar').classList.remove('mostrar');
      zonaSeleccionada = null;
    }

    // Aceptar cambios
    document.getElementById('btnAcetarCambios').addEventListener('click', async () => {
      if (!zonaSeleccionada) return;

      const nuevoNombre = document.getElementById('nuevoNombre').value;

      try {
        const formData = new FormData();
        formData.append('id_zona', zonaSeleccionada.id);
        if (nuevoNombre) formData.append('nombre_zona', nuevoNombre);

        const response = await fetch('/alarma_tec_1/back-end/actualizar_zona.php', {
          method: 'POST',
          body: formData
        });

        const result = await response.json();

        if (result.ok) {
          alert('Zona actualizada correctamente');
          cerrarPopups();
          cargarZonas();
        } else {
          alert('Error: ' + result.mensaje);
        }
      } catch (error) {
        console.error('Error:', error);
        alert('Error al actualizar zona');
      }
    });

    // Cancelar edición
    document.getElementById('btnCancelarCambios').addEventListener('click', cerrarPopups);

    // Confirmar eliminación
    document.getElementById('btnConfirmarEliminar').addEventListener('click', async () => {
      if (!zonaSeleccionada) return;

      try {
        const formData = new FormData();
        formData.append('id_zona', zonaSeleccionada.id);
        formData.append('accion', 'eliminar');

        const response = await fetch('/alarma_tec_1/back-end/actualizar_zona.php', {
          method: 'POST',
          body: formData
        });

        const result = await response.json();

        if (result.ok) {
          alert('Zona eliminada correctamente');
          cerrarPopups();
          cargarZonas();
        } else {
          alert('Error: ' + result.mensaje);
        }
      } catch (error) {
        console.error('Error:', error);
        alert('Error al eliminar zona');
      }
    });

    // Cancelar eliminación
    document.getElementById('btnCancelarEliminar').addEventListener('click', cerrarPopups);

    // Cerrar popup al hacer clic en el overlay
    document.getElementById('overlay').addEventListener('click', (e) => {
      if (e.target.id === 'overlay') {
        cerrarPopups();
      }
    });
  </script>
</body>
</html>