<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Asignar Zonas - Alarma</title>
  <!-- Bootstrap local -->
  <link rel="stylesheet" href="css/bootstrap.custom.min.css">
  <link rel="stylesheet" href="bootstrap-icons-1.13.1/bootstrap-icons.css">
  <!-- Estilos personalizados -->
  <link rel="stylesheet" href="css/plantillaPrincipal.css">
  <style>
    .zona-item {
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .zona-item:hover {
      background-color: #f8f9fa;
    }
    .zona-item.asignada {
      background-color: #d1ecf1;
    }
  </style>
</head>
<body class="bg-light d-flex flex-column min-vh-100">

  <!-- HEADER -->
  <header class="bg-primary text-white py-3 d-flex align-items-center justify-content-between px-4">
    <div class="d-flex align-items-center">
      <!-- Botón hamburguesa móvil -->
      <button class="btn btn-outline-light d-lg-none me-3" id="toggleSidebar">
        <i class="bi bi-list"></i>
      </button>
      <h1 class="h4 m-0"><a href="index.html" class="navbar-brand">Alarma</a></h1>
    </div>
    <div class="d-flex align-items-center">
      <h2 class="h5 m-0 me-2">Administración</h2>
      <i class="bi bi-hdd-stack fs-5"></i>
    </div>
  </header>

  <!-- MAIN -->
  <main class="flex-fill">

  <div class="d-flex flex-grow-1">
    <!-- SIDEBAR (oculta en móvil) -->
    <aside id="sidebar" class="sidebar bg-dark d-flex flex-column align-items-center py-4 min-vh-100">
      <a href="administracionUsuarios.html" class="my-3"><i class="bi bi-house fs-4 p-4"></i></a>
      <a href="dashboardEquipos.html" class="my-3"><i class="bi bi-grid fs-4 p-4"></i></a>
      <a href="administracionRegistrar.html" class="my-3"><i class="bi bi-person-plus fs-4 p-4"></i></a>
      <a href="administracionAsignarEquipos.html" class="my-3"><i class="bi bi-list fs-4 p-4"></i></a>
    </aside>

    <!-- CONTENIDO CON EQUIPOS -->
    <div class="flex-grow-1 ms-3">
      <div class="container-fluid py-4">

        <h3 class="mb-4">Asignar Zonas a Equipos</h3>

        <div class="d-flex align-items-end mb-4 gap-2">
            <div class="flex-grow-1">
              <label for="equipoSelect" class="form-label">Seleccionar Equipo</label>
              <select class="form-select" id="equipoSelect">
                <option value="">-- Cargando equipos --</option>
              </select>
            </div>
            <button type="button" class="btn btn-success" id="btnGuardarCambios" style="display:none;">
              <i class="bi bi-check-circle me-2"></i>Guardar Cambios
            </button>
        </div>

        <!-- Lista de zonas disponibles -->
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">Zonas Disponibles</h5>
          </div>
          <div class="list-group list-group-flush" id="zonasList">
            <div class="list-group-item text-muted">Selecciona un equipo para ver las zonas</div>
          </div>
        </div>
      </div>
    </div>

  </main>

  <!-- FOOTER -->
  <footer class="bg-primary text-white text-center py-2 mt-auto">
  <small class="footer-text">2025 Escuela Técnica N°1 Gral. San Martín Inc. Todos los derechos reservados.</small>
</footer>


  <!-- Bootstrap scripts -->
  <script src="js/bootstrap.bundle.js"></script>
  <script>
    let equipoActual = null;
    let zonasAsignadas = new Set();
    let cambiosPendientes = {};

    const sidebar = document.getElementById('sidebar');
    const toggleBtn = document.getElementById('toggleSidebar');
    const equipoSelect = document.getElementById('equipoSelect');
    const zonasList = document.getElementById('zonasList');
    const btnGuardarCambios = document.getElementById('btnGuardarCambios');

    toggleBtn.addEventListener('click', () => {
      sidebar.classList.toggle('show');
    });

    // Cargar equipos al iniciar
    async function cargarEquipos() {
      try {
        const res = await fetch('/alarma_tec_1/back-end/obtener_equipos.php');
        const equipos = await res.json();
        
        equipoSelect.innerHTML = '<option value="">-- Selecciona un equipo --</option>';
        equipos.forEach(e => {
          const option = document.createElement('option');
          option.value = e.id_equipo;
          option.textContent = e.nombre;
          equipoSelect.appendChild(option);
        });
      } catch (err) {
        console.error('Error cargando equipos:', err);
        equipoSelect.innerHTML = '<option value="">Error al cargar equipos</option>';
      }
    }

    // Cargar zonas cuando se selecciona un equipo
    equipoSelect.addEventListener('change', async () => {
      const idEquipo = equipoSelect.value;
      if (!idEquipo) {
        zonasList.innerHTML = '<div class="list-group-item text-muted">Selecciona un equipo para ver las zonas</div>';
        btnGuardarCambios.style.display = 'none';
        return;
      }

      equipoActual = idEquipo;
      zonasAsignadas.clear();
      cambiosPendientes = {};
      await cargarZonas(idEquipo);
    });

    // Cargar todas las zonas y marcar cuáles están asignadas
    async function cargarZonas(idEquipo) {
      try {
        const [zonasRes, asignadasRes] = await Promise.all([
          fetch('/alarma_tec_1/back-end/obtener_todas_zonas.php'),
          fetch(`/alarma_tec_1/back-end/obtener_zonas.php?id_equipo=${idEquipo}`)
        ]);

        const zonas = await zonasRes.json();
        const asignadas = await asignadasRes.json();

        // Guardar IDs de zonas asignadas
        asignadas.forEach(z => zonasAsignadas.add(z.id_zona));

        // Renderizar zonas
        zonasList.innerHTML = '';
        zonas.forEach(zona => {
          const isAsignada = zonasAsignadas.has(zona.id_zona);
          const item = document.createElement('div');
          item.className = `list-group-item d-flex justify-content-between align-items-center zona-item ${isAsignada ? 'asignada' : ''}`;
          item.dataset.zonaId = zona.id_zona;

          item.innerHTML = `
            <div class="d-flex align-items-center flex-grow-1">
              <i class="bi bi-map fs-4 me-3"></i>
              <div>
                <strong>${zona.descripcion || 'Zona ' + zona.id_zona}</strong><br>
                <small class="text-muted">ID: ${zona.id_zona}</small>
              </div>
            </div>
            <div class="form-check">
              <input class="form-check-input zona-checkbox" type="checkbox" ${isAsignada ? 'checked' : ''}>
            </div>
          `;

          const checkbox = item.querySelector('.zona-checkbox');
          checkbox.addEventListener('change', () => {
            const isNowChecked = checkbox.checked;
            const wasAssigned = zonasAsignadas.has(zona.id_zona);

            // Registrar cambio
            if (isNowChecked !== wasAssigned) {
              cambiosPendientes[zona.id_zona] = isNowChecked;
            } else {
              delete cambiosPendientes[zona.id_zona];
            }

            // Actualizar UI y mostrar botón guardar
            item.classList.toggle('asignada', isNowChecked);
            btnGuardarCambios.style.display = Object.keys(cambiosPendientes).length > 0 ? 'block' : 'none';
          });

          zonasList.appendChild(item);
        });

        btnGuardarCambios.style.display = 'none';
      } catch (err) {
        console.error('Error cargando zonas:', err);
        zonasList.innerHTML = '<div class="list-group-item text-danger">Error al cargar zonas</div>';
      }
    }

    // Guardar cambios
    btnGuardarCambios.addEventListener('click', async () => {
      try {
        btnGuardarCambios.disabled = true;
        btnGuardarCambios.textContent = 'Guardando...';

        const formData = new FormData();
        formData.append('id_equipo', equipoActual);
        formData.append('cambios', JSON.stringify(cambiosPendientes));

        const res = await fetch('/alarma_tec_1/back-end/asignar_zonas.php', {
          method: 'POST',
          body: formData
        });

        const result = await res.json();

        if (result.ok) {
          alert('Cambios guardados correctamente');
          
          // Actualizar equiposAsignados con los nuevos cambios
          for (const [id_zona, asignado] of Object.entries(cambiosPendientes)) {
            if (asignado) {
              zonasAsignadas.add(parseInt(id_zona));
            } else {
              zonasAsignadas.delete(parseInt(id_zona));
            }
          }
          
          cambiosPendientes = {};
          btnGuardarCambios.style.display = 'none';
          
          // Actualizar UI sin recargar
          const items = document.querySelectorAll('.zona-item');
          items.forEach(item => {
            const zonaId = parseInt(item.dataset.zonaId);
            const checkbox = item.querySelector('.zona-checkbox');
            const isAssigned = zonasAsignadas.has(zonaId);
            checkbox.checked = isAssigned;
            item.classList.toggle('asignada', isAssigned);
          });
        } else {
          alert('Error: ' + result.mensaje);
        }
      } catch (err) {
        alert('Error al guardar: ' + err);
      } finally {
        btnGuardarCambios.disabled = false;
        btnGuardarCambios.textContent = 'Guardar Cambios';
      }
    });

    // Iniciar al cargar la página
    document.addEventListener('DOMContentLoaded', cargarEquipos);
  </script>
</body>
</html>
