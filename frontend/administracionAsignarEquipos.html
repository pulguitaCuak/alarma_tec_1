<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Asignar Equipos - Alarma</title>
  <!-- Bootstrap local -->
  <link rel="stylesheet" href="css/bootstrap.custom.min.css">
  <link rel="stylesheet" href="bootstrap-icons-1.13.1/bootstrap-icons.css">
  <!-- Estilos personalizados -->
  <link rel="stylesheet" href="css/plantillaPrincipal.css">
  <style>
    .equipo-item {
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .equipo-item:hover {
      background-color: #f8f9fa;
    }
    .equipo-item.asignado {
      background-color: #d1ecf1;
    }
  </style>
</head>
<body class="bg-light d-flex flex-column min-vh-100">

  <!-- HEADER -->
  <header class="bg-primary text-white py-3 d-flex align-items-center justify-content-between px-4">
    <div class="d-flex align-items-center">
      <!-- Botón hamburguesa móvil -->
      <button class="btn btn-outline-light d-lg-none me-3" id="toggleSidebar">
        <i class="bi bi-list"></i>
      </button>
      <h1 class="h4 m-0"><a href="index.html" class="navbar-brand">Alarma</a></h1>
    </div>
    <div class="d-flex align-items-center">
      <h2 class="h5 m-0 me-2">Administración</h2>
      <i class="bi bi-hdd-stack fs-5"></i>
    </div>
  </header>

  <!-- MAIN -->
  <main class="flex-fill">

  <div class="d-flex flex-grow-1">
    <!-- SIDEBAR (oculta en móvil) -->
    <aside id="sidebar" class="sidebar bg-dark d-flex flex-column align-items-center py-4 min-vh-100">
      <a href="administracionUsuarios.html" class="my-3"><i class="bi bi-house fs-4 p-4"></i></a>
      <a href="dashboardEquipos.html" class="my-3"><i class="bi bi-grid fs-4 p-4"></i></a>
      <a href="administracionRegistrar.html" class="my-3"><i class="bi bi-person-plus fs-4 p-4"></i></a>
      <a href="administracionAsignarEquipos.html" class="my-3"><i class="bi bi-list fs-4 p-4"></i></a>
    </aside>

    <!-- CONTENIDO CON USUARIOS -->
    <div class="flex-grow-1 ms-3">
      <div class="container-fluid py-4">

        <h3 class="mb-4">Asignar Equipos a Usuarios</h3>

        <div class="d-flex align-items-end mb-4 gap-2">
            <div class="flex-grow-1">
              <label for="usuarioSelect" class="form-label">Seleccionar Usuario</label>
              <select class="form-select" id="usuarioSelect">
                <option value="">-- Cargando usuarios --</option>
              </select>
            </div>
            <button type="button" class="btn btn-success" id="btnGuardarCambios" style="display:none;">
              <i class="bi bi-check-circle me-2"></i>Guardar Cambios
            </button>
        </div>

        <!-- Lista de equipos disponibles -->
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">Equipos Disponibles</h5>
          </div>
          <div class="list-group list-group-flush" id="equiposList">
            <div class="list-group-item text-muted">Selecciona un usuario para ver los equipos</div>
          </div>
        </div>
      </div>
    </div>

  </main>

  <!-- FOOTER -->
  <footer class="bg-primary text-white text-center py-2 mt-auto">
  <small class="footer-text">2025 Escuela Técnica N°1 Gral. San Martín Inc. Todos los derechos reservados.</small>
</footer>


  <!-- Bootstrap scripts -->
  <script src="js/bootstrap.bundle.js"></script>
  <script>
    let usuarioActual = null;
    let equiposAsignados = new Set();
    let cambiosPendientes = {};

    const sidebar = document.getElementById('sidebar');
    const toggleBtn = document.getElementById('toggleSidebar');
    const usuarioSelect = document.getElementById('usuarioSelect');
    const equiposList = document.getElementById('equiposList');
    const btnGuardarCambios = document.getElementById('btnGuardarCambios');

    toggleBtn.addEventListener('click', () => {
      sidebar.classList.toggle('show');
    });

    // Cargar usuarios al iniciar
    async function cargarUsuarios() {
      try {
        const res = await fetch('/alarma_tec_1/back-end/obtener_usuarios.php');
        const usuarios = await res.json();
        
        usuarioSelect.innerHTML = '<option value="">-- Selecciona un usuario --</option>';
        usuarios.forEach(u => {
          const option = document.createElement('option');
          option.value = u.id_user;
          option.textContent = `${u.nombre} ${u.apellido}`;
          usuarioSelect.appendChild(option);
        });
      } catch (err) {
        console.error('Error cargando usuarios:', err);
        usuarioSelect.innerHTML = '<option value="">Error al cargar usuarios</option>';
      }
    }

    // Cargar equipos y asignaciones cuando se selecciona un usuario
    usuarioSelect.addEventListener('change', async () => {
      const idUsuario = usuarioSelect.value;
      if (!idUsuario) {
        equiposList.innerHTML = '<div class="list-group-item text-muted">Selecciona un usuario para ver los equipos</div>';
        btnGuardarCambios.style.display = 'none';
        return;
      }

      usuarioActual = idUsuario;
      equiposAsignados.clear();
      cambiosPendientes = {};
      await cargarEquipos(idUsuario);
    });

    // Cargar todos los equipos y marcar cuáles están asignados
    async function cargarEquipos(idUsuario) {
      try {
        const [equiposRes, asignadosRes] = await Promise.all([
          fetch('/alarma_tec_1/back-end/obtener_equipos.php'),
          fetch(`/alarma_tec_1/back-end/obtener_equipos_usuario.php?id=${idUsuario}`)
        ]);

        const equipos = await equiposRes.json();
        const asignados = await asignadosRes.json();

        // Guardar IDs de equipos asignados
        asignados.forEach(e => equiposAsignados.add(e.id_equipo));

        // Renderizar equipos
        equiposList.innerHTML = '';
        equipos.forEach(equipo => {
          const isAsignado = equiposAsignados.has(equipo.id_equipo);
          const item = document.createElement('div');
          item.className = `list-group-item d-flex justify-content-between align-items-center equipo-item ${isAsignado ? 'asignado' : ''}`;
          item.dataset.equipoId = equipo.id_equipo;

          item.innerHTML = `
            <div class="d-flex align-items-center flex-grow-1">
              <i class="bi bi-hdd-rack fs-4 me-3"></i>
              <div>
                <strong>${equipo.nombre}</strong><br>
                <small class="text-muted">${equipo.descripcion || 'Sin descripción'}</small>
              </div>
            </div>
            <div class="form-check">
              <input class="form-check-input equipo-checkbox" type="checkbox" ${isAsignado ? 'checked' : ''}>
            </div>
          `;

          const checkbox = item.querySelector('.equipo-checkbox');
          checkbox.addEventListener('change', () => {
            const isNowChecked = checkbox.checked;
            const wasAssigned = equiposAsignados.has(equipo.id_equipo);

            // Registrar cambio
            if (isNowChecked !== wasAssigned) {
              cambiosPendientes[equipo.id_equipo] = isNowChecked;
            } else {
              delete cambiosPendientes[equipo.id_equipo];
            }

            // Actualizar UI y mostrar botón guardar
            item.classList.toggle('asignado', isNowChecked);
            btnGuardarCambios.style.display = Object.keys(cambiosPendientes).length > 0 ? 'block' : 'none';
          });

          equiposList.appendChild(item);
        });

        btnGuardarCambios.style.display = 'none';
      } catch (err) {
        console.error('Error cargando equipos:', err);
        equiposList.innerHTML = '<div class="list-group-item text-danger">Error al cargar equipos</div>';
      }
    }

    // Guardar cambios
    btnGuardarCambios.addEventListener('click', async () => {
      try {
        btnGuardarCambios.disabled = true;
        btnGuardarCambios.textContent = 'Guardando...';

        const formData = new FormData();
        formData.append('id_usuario', usuarioActual);
        formData.append('cambios', JSON.stringify(cambiosPendientes));

        const res = await fetch('/alarma_tec_1/back-end/asignar_equipos.php', {
          method: 'POST',
          body: formData
        });

        const result = await res.json();

        if (result.ok) {
          alert('Cambios guardados correctamente');
          cambiosPendientes = {};
          btnGuardarCambios.style.display = 'none';
          await cargarEquipos(usuarioActual);
        } else {
          alert('Error: ' + result.mensaje);
        }
      } catch (err) {
        alert('Error al guardar: ' + err);
      } finally {
        btnGuardarCambios.disabled = false;
        btnGuardarCambios.textContent = 'Guardar Cambios';
      }
    });

    // Iniciar al cargar la página
    document.addEventListener('DOMContentLoaded', cargarUsuarios);
  </script>
</body>
</html>