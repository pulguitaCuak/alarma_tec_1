<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Asignar Sensores - Alarma</title>
  <!-- Bootstrap local -->
  <link rel="stylesheet" href="css/bootstrap.custom.min.css">
  <link rel="stylesheet" href="bootstrap-icons-1.13.1/bootstrap-icons.css">
  <!-- Estilos personalizados -->
  <link rel="stylesheet" href="css/plantillaPrincipal.css">
  <style>
    .sensor-item {
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .sensor-item:hover {
      background-color: #f8f9fa;
    }
    .sensor-item.asignado {
      background-color: #d1ecf1;
    }
  </style>
</head>
<body class="bg-light d-flex flex-column min-vh-100">

  <!-- HEADER -->
  <header class="bg-primary text-white py-3 d-flex align-items-center justify-content-between px-4">
    <div class="d-flex align-items-center">
      <!-- Botón hamburguesa móvil -->
      <button class="btn btn-outline-light d-lg-none me-3" id="toggleSidebar">
        <i class="bi bi-list"></i>
      </button>
      <h1 class="h4 m-0"><a href="index.html" class="navbar-brand">Alarma</a></h1>
    </div>
    <div class="d-flex align-items-center">
      <h2 class="h5 m-0 me-2">Administración</h2>
      <i class="bi bi-hdd-stack fs-5"></i>
    </div>
  </header>

  <!-- MAIN -->
  <main class="flex-fill">

  <div class="d-flex flex-grow-1">
    <!-- SIDEBAR (oculta en móvil) -->
    <aside id="sidebar" class="sidebar bg-dark d-flex flex-column align-items-center py-4 min-vh-100" data-included-sidebar>
      <!-- sidebar content loaded from /frontend/includes/sidebar.html -->
    </aside>

    <!-- CONTENIDO CON ZONAS -->
    <div class="flex-grow-1 ms-3">
      <div class="container-fluid py-4">

        <h3 class="mb-4">Asignar Sensores a Zonas</h3>

        <div class="d-flex align-items-end mb-4 gap-2">
            <div class="flex-grow-1">
              <label for="zonaSelect" class="form-label">Seleccionar Zona</label>
              <select class="form-select" id="zonaSelect">
                <option value="">-- Cargando zonas --</option>
              </select>
            </div>
            <button type="button" class="btn btn-success" id="btnGuardarCambios" style="display:none;">
              <i class="bi bi-check-circle me-2"></i>Guardar Cambios
            </button>
        </div>

        <!-- Lista de sensores disponibles -->
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">Sensores Disponibles</h5>
          </div>
          <div class="list-group list-group-flush" id="sensoresList">
            <div class="list-group-item text-muted">Selecciona una zona para ver los sensores</div>
          </div>
        </div>
      </div>
    </div>

  </main>

  <!-- FOOTER -->
  <footer class="bg-primary text-white text-center py-2 mt-auto">
  <small class="footer-text">2025 Escuela Técnica N°1 Gral. San Martín Inc. Todos los derechos reservados.</small>
</footer>


  <!-- Bootstrap scripts -->
  <script src="js/bootstrap.bundle.js"></script>
  <script src="/alarma_tec_1/frontend/js/sidebar.js"></script>
  <script>
    let zonaActual = null;
    let sensoresAsignados = new Set();
    let cambiosPendientes = {};

    const sidebar = document.getElementById('sidebar');
    const toggleBtn = document.getElementById('toggleSidebar');
    const zonaSelect = document.getElementById('zonaSelect');
    const sensoresList = document.getElementById('sensoresList');
    const btnGuardarCambios = document.getElementById('btnGuardarCambios');

    toggleBtn.addEventListener('click', () => {
      sidebar.classList.toggle('show');
    });

    // Cargar zonas al iniciar
    async function cargarZonas() {
      try {
        const res = await fetch('/alarma_tec_1/back-end/obtener_todas_zonas.php');
        const zonas = await res.json();
        
        zonaSelect.innerHTML = '<option value="">-- Selecciona una zona --</option>';
        zonas.forEach(z => {
          const option = document.createElement('option');
          option.value = z.id_zona;
          option.textContent = z.descripcion || 'Zona ' + z.id_zona;
          zonaSelect.appendChild(option);
        });
      } catch (err) {
        console.error('Error cargando zonas:', err);
        zonaSelect.innerHTML = '<option value="">Error al cargar zonas</option>';
      }
    }

    // Cargar sensores cuando se selecciona una zona
    zonaSelect.addEventListener('change', async () => {
      const idZona = zonaSelect.value;
      if (!idZona) {
        sensoresList.innerHTML = '<div class="list-group-item text-muted">Selecciona una zona para ver los sensores</div>';
        btnGuardarCambios.style.display = 'none';
        return;
      }

      zonaActual = idZona;
      sensoresAsignados.clear();
      cambiosPendientes = {};
      await cargarSensores(idZona);
    });

    // Cargar todos los sensores y marcar cuáles están asignados
    async function cargarSensores(idZona) {
      try {
        const [sensoresRes, asignadosRes] = await Promise.all([
          fetch('/alarma_tec_1/back-end/obtener_todos_sensores.php'),
          fetch(`/alarma_tec_1/back-end/obtener_sensores_zona.php?id_zona=${idZona}`)
        ]);

        const sensores = await sensoresRes.json();
        const asignados = await asignadosRes.json();

        // Guardar IDs de sensores asignados
        asignados.forEach(s => sensoresAsignados.add(s.id_sensor));

        // Renderizar sensores
        sensoresList.innerHTML = '';
        sensores.forEach(sensor => {
          const isAsignado = sensoresAsignados.has(sensor.id_sensor);
          const item = document.createElement('div');
          item.className = `list-group-item d-flex justify-content-between align-items-center sensor-item ${isAsignado ? 'asignado' : ''}`;
          item.dataset.sensorId = sensor.id_sensor;

          item.innerHTML = `
            <div class="d-flex align-items-center flex-grow-1">
              <i class="bi bi-wifi fs-4 me-3"></i>
              <div>
                <strong>${sensor.nombre}</strong><br>
                <small class="text-muted">${sensor.descripcion || 'Sin descripción'}</small>
              </div>
            </div>
            <div class="form-check">
              <input class="form-check-input sensor-checkbox" type="checkbox" ${isAsignado ? 'checked' : ''}>
            </div>
          `;

          const checkbox = item.querySelector('.sensor-checkbox');
          checkbox.addEventListener('change', () => {
            const isNowChecked = checkbox.checked;
            const wasAssigned = sensoresAsignados.has(sensor.id_sensor);

            // Registrar cambio
            if (isNowChecked !== wasAssigned) {
              cambiosPendientes[sensor.id_sensor] = isNowChecked;
            } else {
              delete cambiosPendientes[sensor.id_sensor];
            }

            // Actualizar UI y mostrar botón guardar
            item.classList.toggle('asignado', isNowChecked);
            btnGuardarCambios.style.display = Object.keys(cambiosPendientes).length > 0 ? 'block' : 'none';
          });

          sensoresList.appendChild(item);
        });

        btnGuardarCambios.style.display = 'none';
      } catch (err) {
        console.error('Error cargando sensores:', err);
        sensoresList.innerHTML = '<div class="list-group-item text-danger">Error al cargar sensores</div>';
      }
    }

    // Guardar cambios
    btnGuardarCambios.addEventListener('click', async () => {
      try {
        btnGuardarCambios.disabled = true;
        btnGuardarCambios.textContent = 'Guardando...';

        const formData = new FormData();
        formData.append('id_zona', zonaActual);
        formData.append('cambios', JSON.stringify(cambiosPendientes));

        const res = await fetch('/alarma_tec_1/back-end/asignar_sensores.php', {
          method: 'POST',
          body: formData
        });

        const result = await res.json();

        if (result.ok) {
          alert('Cambios guardados correctamente');
          
          // Actualizar sensoresAsignados con los nuevos cambios
          for (const [id_sensor, asignado] of Object.entries(cambiosPendientes)) {
            if (asignado) {
              sensoresAsignados.add(parseInt(id_sensor));
            } else {
              sensoresAsignados.delete(parseInt(id_sensor));
            }
          }
          
          cambiosPendientes = {};
          btnGuardarCambios.style.display = 'none';
          
          // Actualizar UI sin recargar
          const items = document.querySelectorAll('.sensor-item');
          items.forEach(item => {
            const sensorId = parseInt(item.dataset.sensorId);
            const checkbox = item.querySelector('.sensor-checkbox');
            const isAssigned = sensoresAsignados.has(sensorId);
            checkbox.checked = isAssigned;
            item.classList.toggle('asignado', isAssigned);
          });
        } else {
          alert('Error: ' + result.mensaje);
        }
      } catch (err) {
        alert('Error al guardar: ' + err);
      } finally {
        btnGuardarCambios.disabled = false;
        btnGuardarCambios.textContent = 'Guardar Cambios';
      }
    });

    // Iniciar al cargar la página
    document.addEventListener('DOMContentLoaded', cargarZonas);
  </script>
</body>
</html>
